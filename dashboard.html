<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Skate Winery</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <header class="dashboard-header">
        <div class="logo">SKATE WINERY</div>
        <div class="header-user">
            <span id="welcomeMessage">Loading...</span>
            <button id="logoutButton">Logout</button>
        </div>
    </header>

    <main class="dashboard-container">
        <section class="my-investments-card">
            <h2>My Active Investments</h2>
            <div id="myInvestmentsContainer">
                <p>Loading your investments...</p>
            </div>
        </section>

        <section class="user-details-card">
            <h2>Your Details</h2>
            <p><strong>Phone:</strong> <span id="phoneDetail">-</span></p>
            <p><strong>Your Referral Code:</strong> <span id="referralCodeDetail">-</span></p>
        </section>

        <section class="investment-plans-section">
            <h2>Available Investment Plans</h2>
            <div class="plans-grid" id="plansContainer">
                </div>
        </section>
    </main>

    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            // Get references to all our elements
            const welcomeMessage = document.getElementById('welcomeMessage');
            const phoneDetail = document.getElementById('phoneDetail');
            const referralCodeDetail = document.getElementById('referralCodeDetail');
            const plansContainer = document.getElementById('plansContainer');
            const logoutButton = document.getElementById('logoutButton');
            const myInvestmentsContainer = document.getElementById('myInvestmentsContainer');

            if (!token) { window.location.href = 'login.html'; return; }

            try {
                const response = await fetch('http://localhost:3000/api/dashboard', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }
                const data = await response.json();

                // --- Populate User Details ---
                welcomeMessage.textContent = `Welcome, ${data.user.full_name}!`;
                phoneDetail.textContent = data.user.phone_number;
                referralCodeDetail.textContent = data.user.own_referral_code;

                // --- NEW: Populate "My Active Investments" section ---
                myInvestmentsContainer.innerHTML = ''; // Clear loading text
                if (data.investments.length === 0) {
                    myInvestmentsContainer.innerHTML = '<p>You have no active investments. Choose a plan below to get started!</p>';
                } else {
                    data.investments.forEach(inv => {
                        const investmentItem = document.createElement('div');
                        investmentItem.className = 'investment-item'; // We will need to add styles for this
                        
                        const startDate = new Date(inv.start_date).toLocaleDateString();
                        const endDate = new Date(inv.end_date).toLocaleDateString();

                        investmentItem.innerHTML = `
                            <h4>${inv.plan_name}</h4>
                            <p><strong>Amount:</strong> ₦${Number(inv.investment_amount).toLocaleString()}</p>
                            <p><strong>Started:</strong> ${startDate}</p>
                            <p><strong>Ends:</strong> ${endDate}</p>
                        `;
                        myInvestmentsContainer.appendChild(investmentItem);
                    });
                }


                // --- Populate Available Plans section ---
                plansContainer.innerHTML = '';
                data.plans.forEach(plan => {
                    const planCard = document.createElement('div');
                    planCard.className = 'plan-card';
                    planCard.innerHTML = `
                        <h3>${plan.name}</h3>
                        <p><strong>Price:</strong> ₦${plan.price.toLocaleString()}</p>
                        <p><strong>Daily Revenue:</strong> ₦${plan.daily_revenue.toLocaleString()}</p>
                        <button class="btn-cta invest-button" data-plan-id="${plan.id}" style="margin-top: 1rem;">Invest</button>
                    `;
                    plansContainer.appendChild(planCard);
                });

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }

            // Event Listeners for buttons
            plansContainer.addEventListener('click', async (event) => { /* ... existing invest button code ... */ });
            logoutButton.addEventListener('click', () => { /* ... existing logout button code ... */ });
        });
    </script>
</body>
</html>
