<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Skate Winery</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <header class="dashboard-header">
        <div class="logo">SKATE WINERY</div>
        <div class="header-user">
            <span id="welcomeMessage">Loading...</span>
            <button id="logoutButton">Logout</button>
        </div>
    </header>

    <main class="dashboard-container">
        <section class="user-details-card">
            <h2>Your Details</h2>
            <p><strong>Phone:</strong> <span id="phoneDetail">-</span></p>
            <p><strong>Your Referral Code:</strong> <span id="referralCodeDetail">-</span></p>
        </section>

        <section class="investment-plans-section">
            <h2>Available Investment Plans</h2>
            <div class="plans-grid" id="plansContainer">
                </div>
        </section>
    </main>

    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const phoneDetail = document.getElementById('phoneDetail');
            const referralCodeDetail = document.getElementById('referralCodeDetail');
            const plansContainer = document.getElementById('plansContainer');
            const logoutButton = document.getElementById('logoutButton');

            if (!token) { window.location.href = 'login.html'; return; }

            try {
                const response = await fetch('http://localhost:3000/api/dashboard', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }
                const data = await response.json();

                welcomeMessage.textContent = `Welcome, ${data.user.full_name}!`;
                phoneDetail.textContent = data.user.phone_number;
                referralCodeDetail.textContent = data.user.own_referral_code;

                plansContainer.innerHTML = '';
                // Use data.plans from the server's response
                data.plans.forEach(plan => {
                    const planCard = document.createElement('div');
                    planCard.className = 'plan-card';
                    // NEW: Added data-plan-id to the button
                    planCard.innerHTML = `
                        <h3>${plan.name}</h3>
                        <p><strong>Price:</strong> ₦${plan.price.toLocaleString()}</p>
                        <p><strong>Daily Revenue:</strong> ₦${plan.daily_revenue.toLocaleString()}</p>
                        <button class="btn-cta invest-button" data-plan-id="${plan.id}" style="margin-top: 1rem;">Invest</button>
                    `;
                    plansContainer.appendChild(planCard);
                });

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }

            // --- NEW: Event Listener for Invest Buttons ---
            plansContainer.addEventListener('click', async (event) => {
                // Check if an invest button was clicked
                if (event.target.classList.contains('invest-button')) {
                    const planId = event.target.dataset.planId;
                    
                    if (!confirm(`Are you sure you want to invest in this plan?`)) {
                        return; // Stop if the user clicks cancel
                    }

                    try {
                        const response = await fetch('http://localhost:3000/api/invest', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + token
                            },
                            body: JSON.stringify({ planId: planId })
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert('Success: ' + result.message);
                        } else {
                            alert('Error: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Investment error:', error);
                        alert('An investment error occurred. Please try again.');
                    }
                }
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>
