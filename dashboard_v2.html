<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | JJB Wines</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#10b981', // Emerald Green
                            600: '#059669',
                            900: '#064e3b',
                        },
                        dark: '#0f172a',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F3F4F6; /* Soft gray background */
            background-image: radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%),
                              radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.1) 0px, transparent 50%);
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        }

        /* Hover Cards */
        .hover-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #10b981;
        }

        /* Smooth Button */
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.39);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px 0 rgba(16, 185, 129, 0.39);
        }
        .btn-primary:active {
            transform: scale(0.98);
        }

        /* --- FOMO NOTIFICATION CSS --- */
        #fomo-popup {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            border-left: 4px solid #10B981;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            font-family: 'Inter', sans-serif;
            z-index: 50;
            transform: translateX(-150%);
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            gap: 16px;
            max-width: 360px;
            width: 90%;
        }
        #fomo-popup.show { transform: translateX(0); }
    </style>
</head>

<body class="text-gray-800 antialiased min-h-screen flex flex-col">

    <header class="glass-header fixed top-0 w-full z-40 h-16 flex items-center justify-between px-4 lg:px-8">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-brand-500 rounded-lg flex items-center justify-center text-white font-bold">J</div>
            <span class="font-display font-bold text-lg text-gray-900 tracking-tight">JJB Wines</span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-full border border-gray-200">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-medium text-gray-600">System Operational</span>
            </div>
            <button id="logoutButton" class="text-sm font-medium text-gray-500 hover:text-red-600 transition-colors flex items-center gap-1">
                <i class="ph ph-sign-out text-lg"></i>
                <span>Logout</span>
            </button>
        </div>
    </header>

    <main class="flex-grow pt-24 pb-12 px-4 lg:px-8 max-w-7xl mx-auto w-full">
        
        <div class="mb-8">
            <h1 id="welcomeMessage" class="font-display text-3xl md:text-4xl font-bold text-gray-900">Loading Dashboard...</h1>
            <p class="text-gray-500 mt-1">Here is what's happening with your portfolio today.</p>
        </div>

        <div class="glass-panel rounded-2xl p-6 mb-8 relative overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Portfolio Growth</h3>
                    <div class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <span>Overview</span>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">+12.5% this month</span>
                    </div>
                </div>
                <button class="p-2 bg-gray-50 hover:bg-gray-100 rounded-lg transition text-gray-400">
                    <i class="ph ph-chart-line-up text-xl"></i>
                </button>
            </div>
            
            <div class="h-48 w-full relative">
                <svg width="100%" height="100%" viewBox="0 0 300 100" preserveAspectRatio="none" class="drop-shadow-sm">
                    <defs>
                        <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stop-color="#10B981" stop-opacity="0.2"/>
                            <stop offset="100%" stop-color="#10B981" stop-opacity="0"/>
                        </linearGradient>
                    </defs>
                    <path d="M0,70 Q50,20 100,50 T200,80 T300,40 V100 H0 Z" fill="url(#chartGradient)" />
                    <path d="M0,70 Q50,20 100,50 T200,80 T300,40" stroke="#10B981" fill="none" stroke-width="3" stroke-linecap="round" />
                </svg>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-display text-xl font-bold text-gray-900">Active Investments</h2>
                    <span class="text-sm text-gray-500">Live Returns</span>
                </div>
                
                <div id="myInvestmentsContainer" class="grid gap-4">
                    <div class="animate-pulse flex space-x-4 p-4 glass-panel rounded-xl">
                        <div class="flex-1 space-y-4 py-1">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="space-y-2">
                                <div class="h-4 bg-gray-200 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-display text-xl font-bold text-gray-900">Invest Now</h2>
                    <a href="#" class="text-sm font-medium text-brand-600 hover:text-brand-700">View All</a>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-1">
                    <div id="plansContainer" class="space-y-1">
                        <p class="p-4 text-gray-400 text-sm">Loading market data...</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="fomo-popup">
        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 flex-shrink-0">
            <i class="ph-fill ph-check-circle text-xl"></i>
        </div>
        <div class="flex flex-col">
            <span class="text-sm font-bold text-gray-900" id="fomo-user">Loading...</span>
            <span class="text-xs text-gray-600 mt-0.5" id="fomo-action">Just invested</span>
            <span class="text-[10px] text-gray-400 mt-1 uppercase tracking-wide font-medium" id="fomo-ago">Just now</span>
        </div>
    </div>

    <script>
        // --- 1. FOMO NOTIFICATION LOGIC ---
        const fomoConfig = {
            names: [
                "Chinedu Okeke", "Fatima Bello", "Tunde Bakare", "Ngozi Eze", 
                "Emeka Johnson", "Adebayo Ogunlesi", "Chioma Jesus", "Yusuf Ibrahim",
                "Funke Akindele", "Musa Yar'adua", "Blessing Okoro", "Segun Arinze",
                "Zainab Ahmed", "Kelechi Iheanacho", "Olamide Baddo", "Grace Ojo",
                "Samuel Kalu", "Aisha Buhari", "David Adeleke", "Mary Slessor"
            ],
            products: [
                "Casper Wines VIP", "Casper Gold Plan", "JJB Branded Reserve", 
                "Skate Winery Special", "Casper Premium Batch", "JJB Export Line"
            ],
            actions: [
                "just invested ₦50,000 in", "just purchased", "started a plan with", 
                "reinvested profits into", "successfully withdrew from"
            ],
            times: ["Just now", "2 mins ago", "5 mins ago", "12s ago", "Right now"]
        };

        function showFomoNotification() {
            const popup = document.getElementById('fomo-popup');
            const userEl = document.getElementById('fomo-user');
            const actionEl = document.getElementById('fomo-action');
            const timeEl = document.getElementById('fomo-ago');
            
            const name = fomoConfig.names[Math.floor(Math.random() * fomoConfig.names.length)];
            const product = fomoConfig.products[Math.floor(Math.random() * fomoConfig.products.length)];
            const action = fomoConfig.actions[Math.floor(Math.random() * fomoConfig.actions.length)];
            const time = fomoConfig.times[Math.floor(Math.random() * fomoConfig.times.length)];

            userEl.textContent = name;
            if(action.includes("withdrew")) {
                actionEl.textContent = `${action} ₦${Math.floor(Math.random() * 50 + 10) * 1000}`;
            } else {
                actionEl.textContent = `${action} ${product}`;
            }
            timeEl.textContent = time;

            popup.classList.add('show');
            setTimeout(() => { popup.classList.remove('show'); }, 6000);
        }
        
        // Start FOMO Loop
        setTimeout(showFomoNotification, 3000); // First one after 3s
        setInterval(() => { showFomoNotification(); }, Math.floor(Math.random() * 10000) + 12000);


        // --- 2. MAIN APP LOGIC (Preserved & Enhanced) ---
        window.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const myInvestmentsContainer = document.getElementById('myInvestmentsContainer');
            const plansContainer = document.getElementById('plansContainer');
            const logoutButton = document.getElementById('logoutButton');

            if (!token) { window.location.href = 'index.html'; return; }

            try {
                // Fetch Data
                const response = await fetch('https://jjb24-backend.onrender.com/api/dashboard', { 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                
                // Note: I updated localhost to your Render URL above just in case, 
                // but if you are testing locally, switch it back to http://localhost:3000
                
                if (!response.ok) { localStorage.removeItem('token'); window.location.href = 'index.html'; return; }
                const data = await response.json();

                // 1. UPDATE WELCOME
                welcomeMessage.innerHTML = `Welcome back, <span class="text-brand-600">${data.user.full_name.split(' ')[0]}</span>`;

                // 2. RENDER INVESTMENTS (Styled)
                myInvestmentsContainer.innerHTML = '';
                if (data.investments.length === 0) {
                    myInvestmentsContainer.innerHTML = `
                        <div class="glass-panel p-8 rounded-xl text-center border-dashed border-2 border-gray-300">
                            <i class="ph ph-plant text-4xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500 font-medium">No active investments yet.</p>
                            <p class="text-sm text-gray-400">Choose a plan from the right to start earning.</p>
                        </div>`;
                } else {
                    data.investments.forEach(inv => {
                        const item = document.createElement('div');
                        item.className = 'glass-panel p-5 rounded-xl flex flex-col md:flex-row md:items-center justify-between gap-4 hover-card group border-l-4 border-brand-500';
                        const startDate = new Date(inv.start_date).toLocaleDateString();
                        
                        // Beautiful Investment Card HTML
                        item.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-brand-50 flex items-center justify-center text-brand-600 group-hover:bg-brand-500 group-hover:text-white transition-colors">
                                    <i class="ph-fill ph-wine text-2xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-900">${inv.plan_name}</h4>
                                    <div class="flex items-center gap-2 text-xs text-gray-500">
                                        <i class="ph ph-calendar-blank"></i>
                                        <span>Started: ${startDate}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-400 uppercase font-semibold">Daily Return</p>
                                <p class="text-lg font-bold text-brand-600 font-display">+ ₦${Number(inv.daily_revenue).toLocaleString()}</p>
                            </div>
                        `;
                        myInvestmentsContainer.appendChild(item);
                    });
                }

                // 3. RENDER PLANS (Styled)
                plansContainer.innerHTML = '';
                data.plans.forEach(plan => {
                    const card = document.createElement('div');
                    card.className = 'p-4 hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-0';
                    
                    // Beautiful Plan Card HTML
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-900">${plan.name}</h3>
                            <span class="bg-gray-900 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">HOT</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-sm text-gray-500">Entry Price</p>
                                <p class="text-lg font-bold text-gray-900 font-display">₦${plan.price.toLocaleString()}</p>
                            </div>
                            <button class="invest-button btn-primary text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transform transition" data-plan-id="${plan.id}">
                                Invest
                            </button>
                        </div>
                    `;
                    plansContainer.appendChild(card);
                });

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                // In production, uncomment the next lines to force logout on error
                // localStorage.removeItem('token');
                // window.location.href = 'index.html';
            }

            // Click Handler (Same as before)
            plansContainer.addEventListener('click', async (event) => {
                if (event.target.classList.contains('invest-button')) {
                    const planId = event.target.dataset.planId;
                    if (!confirm(`Confirm investment for this plan?`)) { return; }
                    
                    const btn = event.target;
                    const originalText = btn.innerText;
                    btn.innerText = "Processing...";
                    btn.disabled = true;

                    try {
                        const response = await fetch('https://jjb24-backend.onrender.com/api/invest', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                            body: JSON.stringify({ planId: planId })
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert('Success: ' + result.message);
                            window.location.reload();
                        } else {
                            alert('Error: ' + result.message);
                            btn.innerText = originalText;
                            btn.disabled = false;
                        }
                    } catch (error) {
                        console.error('Investment error:', error);
                        alert('Connection error. Please try again.');
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                }
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = 'login.html'; // Assuming you have a login.html
            });
        });
    </script>
</body>
</html>
